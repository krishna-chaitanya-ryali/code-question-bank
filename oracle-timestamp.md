SELECT COUNT(*)
FROM RAP_METRICS_DETAILS d
JOIN RAP r ON d.RAP_ID = r.RAP_ID
JOIN MEET_INSTC mi ON r.RAP_INSTANCE_ID = mi.MEET_INSTC_ID
JOIN RAP_METRICS_PACK_MAPPING p ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
JOIN RAP_MASTER_METRIC_DETAILS m
  ON p.METRICS_DISP = m.MASTER_METRIC_NAME
 AND r.RISK_TYPE_ID = m.RISK_TYPE_ID
WHERE d.MASTER_METRIC_ID IS NULL
  AND mi.ACT_ON_RCRD = 'insert-rap-open';



MERGE INTO RAP_METRICS_DETAILS d
USING (
    SELECT
        d.ROWID AS d_rowid,
        m.MASTER_METRIC_ID
    FROM RAP_METRICS_DETAILS d
    JOIN RAP r ON d.RAP_ID = r.RAP_ID
    JOIN MEET_INSTC mi ON r.RAP_INSTANCE_ID = mi.MEET_INSTC_ID
    JOIN RAP_METRICS_PACK_MAPPING p ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
    JOIN RAP_MASTER_METRIC_DETAILS m
      ON p.METRICS_DISP = m.MASTER_METRIC_NAME
     AND r.RISK_TYPE_ID = m.RISK_TYPE_ID
    WHERE d.MASTER_METRIC_ID IS NULL
      AND mi.ACT_ON_RCRD = 'insert-rap-open'
) src
ON (d.ROWID = src.d_rowid)
WHEN MATCHED THEN
  UPDATE SET d.MASTER_METRIC_ID = src.MASTER_METRIC_ID;
