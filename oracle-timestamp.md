SELECT d.RAP_ID, d.RAP_METRICS_MAPPING_ID, p.METRICS_DISP, m.MASTER_METRIC_ID, m.RISK_TYPE_ID, mi.MEET_INSTC_ID
FROM RAP_METRICS_DETAILS d
JOIN RAP r ON d.RAP_ID = r.RAP_ID
JOIN MEET_INSTC mi ON r.RAP_INSTANCE_ID = mi.MEET_INSTC_ID
JOIN RAP_METRICS_PACK_MAPPING p ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
JOIN RAP_MASTER_METRIC_DETAILS m ON p.METRICS_DISP = m.MASTER_METRIC_NAME
WHERE d.MASTER_METRIC_ID IS NULL
  AND mi.ACT_ON_RCRD = 'insert-rap-open'
  AND m.RISK_TYPE_ID = (
      SELECT MIN(RISK_TYPE_ID)
      FROM RAP_MASTER_METRIC_DETAILS
      WHERE MASTER_METRIC_NAME = m.MASTER_METRIC_NAME
  );


MERGE INTO RAP_METRICS_DETAILS d
USING (
    SELECT d.ROWID AS d_rowid,
           m.MASTER_METRIC_ID
    FROM RAP_METRICS_DETAILS d
    JOIN RAP r ON d.RAP_ID = r.RAP_ID
    JOIN MEET_INSTC mi ON r.RAP_INSTANCE_ID = mi.MEET_INSTC_ID
    JOIN RAP_METRICS_PACK_MAPPING p ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
    JOIN (
        SELECT MASTER_METRIC_NAME, MIN(RISK_TYPE_ID) AS min_risk_type_id
        FROM RAP_MASTER_METRIC_DETAILS
        GROUP BY MASTER_METRIC_NAME
    ) min_m ON p.METRICS_DISP = min_m.MASTER_METRIC_NAME
    JOIN RAP_MASTER_METRIC_DETAILS m 
      ON m.MASTER_METRIC_NAME = min_m.MASTER_METRIC_NAME 
     AND m.RISK_TYPE_ID = min_m.min_risk_type_id
    WHERE d.MASTER_METRIC_ID IS NULL
      AND mi.ACT_ON_RCRD = 'insert-rap-open'
) src
ON (d.ROWID = src.d_rowid)
WHEN MATCHED THEN
UPDATE SET d.MASTER_METRIC_ID = src.MASTER_METRIC_ID;

====================================================
SELECT d.RAP_ID, d.RAP_METRICS_MAPPING_ID, p.METRICS_DISP, m.MASTER_METRIC_ID, m.RISK_TYPE_ID, mi.MEET_INSTANCE_ID
FROM RAP_METRICS_DETAILS d
JOIN RAP r ON d.RAP_ID = r.RAP_ID
JOIN MEET_INSTC mi ON r.RAP_INSTANCE_ID = mi.MEET_INSTANCE_ID
JOIN RAP_METRICS_PACK_MAPPING p ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
JOIN RAP_MASTER_METRIC_DETAILS m ON p.METRICS_DISP = m.MASTER_METRIC_NAME
WHERE d.MASTER_METRIC_ID IS NULL
  AND mi.ACT_ON_RCRD = 'insert_rap_open'
  AND m.RISK_TYPE_ID = (
      SELECT MIN(RISK_TYPE_ID)
      FROM RAP_MASTER_METRIC_DETAILS
      WHERE MASTER_METRIC_NAME = m.MASTER_METRIC_NAME
  );


MERGE INTO RAP_METRICS_DETAILS d
USING (
    SELECT d.ROWID AS d_rowid,
           m.MASTER_METRIC_ID
    FROM RAP_METRICS_DETAILS d
    JOIN RAP r ON d.RAP_ID = r.RAP_ID
    JOIN MEET_INSTC mi ON r.RAP_INSTANCE_ID = mi.MEET_INSTANCE_ID
    JOIN RAP_METRICS_PACK_MAPPING p ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
    JOIN (
        SELECT MASTER_METRIC_NAME, MIN(RISK_TYPE_ID) AS min_risk_type_id
        FROM RAP_MASTER_METRIC_DETAILS
        GROUP BY MASTER_METRIC_NAME
    ) min_m ON p.METRICS_DISP = min_m.MASTER_METRIC_NAME
    JOIN RAP_MASTER_METRIC_DETAILS m 
      ON m.MASTER_METRIC_NAME = min_m.MASTER_METRIC_NAME 
     AND m.RISK_TYPE_ID = min_m.min_risk_type_id
    WHERE d.MASTER_METRIC_ID IS NULL
      AND mi.ACT_ON_RCRD = 'insert_rap_open'
) src
ON (d.ROWID = src.d_rowid)
WHEN MATCHED THEN
UPDATE SET d.MASTER_METRIC_ID = src.MASTER_METRIC_ID;
