Title: End-to-End Risk Type and Master Metric Cleanup Process in RAP Tables

Objective

Standardize and clean up data across RAP-related tables, specifically:

Eliminate duplicate RISK_TYPE_IDs.

Backfill missing MASTER_METRIC_IDs in RAP_METRICS_DETAILS.

Ensure accurate mappings between metrics and risk types.

Step 1: Identify and Map Duplicate RISK_TYPE_IDs

CREATE GLOBAL TEMPORARY TABLE RISK_TYPE_ID_MAPPING (
    OLD_RISK_TYPE_ID NUMBER,
    NEW_RISK_TYPE_ID NUMBER,
    RISK_HEADER      VARCHAR2(200)
) ON COMMIT PRESERVE ROWS;

Populate Mapping Table

INSERT INTO RISK_TYPE_ID_MAPPING (RISK_HEADER, OLD_RISK_TYPE_ID, NEW_RISK_TYPE_ID)
WITH duplicates AS (
    SELECT RISK_HEADER, RISK_TYPE_ID,
           MIN(RISK_TYPE_ID) OVER (PARTITION BY RISK_HEADER) AS NEW_RISK_TYPE_ID
    FROM RAP_RISK_TYPE
)
SELECT RISK_HEADER, RISK_TYPE_ID, NEW_RISK_TYPE_ID
FROM duplicates
WHERE RISK_TYPE_ID != NEW_RISK_TYPE_ID;

Step 2: Update RISK_TYPE_IDs in Dependent Tables

UPDATE RAP r
SET r.RISK_TYPE_ID = (
    SELECT m.NEW_RISK_TYPE_ID FROM RISK_TYPE_ID_MAPPING m
    WHERE m.OLD_RISK_TYPE_ID = r.RISK_TYPE_ID
)
WHERE EXISTS (
    SELECT 1 FROM RISK_TYPE_ID_MAPPING m
    WHERE m.OLD_RISK_TYPE_ID = r.RISK_TYPE_ID
);

UPDATE RAP_MASTER_METRIC_DETAILS rmd
SET rmd.RISK_TYPE_ID = (
    SELECT m.NEW_RISK_TYPE_ID FROM RISK_TYPE_ID_MAPPING m
    WHERE m.OLD_RISK_TYPE_ID = rmd.RISK_TYPE_ID
)
WHERE EXISTS (
    SELECT 1 FROM RISK_TYPE_ID_MAPPING m
    WHERE m.OLD_RISK_TYPE_ID = rmd.RISK_TYPE_ID
);

Delete Old Duplicate RISK_TYPE_IDs

DELETE FROM RAP_RISK_TYPE
WHERE RISK_TYPE_ID IN (
    SELECT OLD_RISK_TYPE_ID FROM RISK_TYPE_ID_MAPPING
);

Step 3: Identify and Clean Duplicate MASTER_METRIC_IDs

Create Mapping Table

CREATE GLOBAL TEMPORARY TABLE MASTER_METRIC_ID_MAPPING (
    MASTER_METRIC_NAME VARCHAR2(500),
    RISK_TYPE_ID NUMBER,
    OLD_MASTER_METRIC_ID NUMBER,
    NEW_MASTER_METRIC_ID NUMBER
) ON COMMIT PRESERVE ROWS;

Insert Only True Duplicates (Same Name + Same Risk Type)

INSERT INTO MASTER_METRIC_ID_MAPPING (MASTER_METRIC_NAME, RISK_TYPE_ID, OLD_MASTER_METRIC_ID, NEW_MASTER_METRIC_ID)
WITH ranked AS (
    SELECT MASTER_METRIC_ID, MASTER_METRIC_NAME, RISK_TYPE_ID,
           MIN(MASTER_METRIC_ID) OVER (PARTITION BY MASTER_METRIC_NAME, RISK_TYPE_ID) AS NEW_MASTER_METRIC_ID
    FROM RAP_MASTER_METRIC_DETAILS
)
SELECT MASTER_METRIC_NAME, RISK_TYPE_ID, MASTER_METRIC_ID, NEW_MASTER_METRIC_ID
FROM ranked
WHERE MASTER_METRIC_ID != NEW_MASTER_METRIC_ID;

Update All References in RAP_METRICS_DETAILS

UPDATE RAP_METRICS_DETAILS d
SET MASTER_METRIC_ID = (
    SELECT m.NEW_MASTER_METRIC_ID
    FROM MASTER_METRIC_ID_MAPPING m
    WHERE m.OLD_MASTER_METRIC_ID = d.MASTER_METRIC_ID
)
WHERE EXISTS (
    SELECT 1
    FROM MASTER_METRIC_ID_MAPPING m
    WHERE m.OLD_MASTER_METRIC_ID = d.MASTER_METRIC_ID
);

Delete Only the True Duplicate Master Metric Records

DELETE FROM RAP_MASTER_METRIC_DETAILS
WHERE MASTER_METRIC_ID IN (
    SELECT OLD_MASTER_METRIC_ID FROM MASTER_METRIC_ID_MAPPING
);

Note: This cleanup ensures that only the minimum MASTER_METRIC_ID per (MASTER_METRIC_NAME, RISK_TYPE_ID) is kept, and all references are updated accordingly.

Step 4: Fix Incorrect RISK_TYPE_ID in RAP_MASTER_METRIC_DETAILS

Problem:
Some MASTER_METRIC_NAMEs had mismatched RISK_TYPE_ID between RAP_MASTER_METRIC_DETAILS and RAP table.

Solution:
Update RAP_MASTER_METRIC_DETAILS to match the RISK_TYPE_ID used in RAP for the same metric:

UPDATE RAP_MASTER_METRIC_DETAILS mmd
SET RISK_TYPE_ID = (
    SELECT r.RISK_TYPE_ID
    FROM RAP_METRICS_PACK_MAPPING p
    JOIN RAP_METRICS_DETAILS d ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
    JOIN RAP r ON r.RAP_ID = d.RAP_ID
    WHERE p.METRICS_DISP = mmd.MASTER_METRIC_NAME
      AND ROWNUM = 1
)
WHERE EXISTS (
    SELECT 1
    FROM RAP_METRICS_PACK_MAPPING p
    JOIN RAP_METRICS_DETAILS d ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
    JOIN RAP r ON r.RAP_ID = d.RAP_ID
    WHERE p.METRICS_DISP = mmd.MASTER_METRIC_NAME
      AND r.RISK_TYPE_ID IS NOT NULL
      AND mmd.RISK_TYPE_ID != r.RISK_TYPE_ID
);

Step 5: Backfill Missing MASTER_METRIC_IDs in RAP_METRICS_DETAILS

MERGE INTO RAP_METRICS_DETAILS d
USING (
    SELECT
        d.ROWID AS d_rowid,
        m.MASTER_METRIC_ID
    FROM RAP_METRICS_DETAILS d
    JOIN RAP r ON d.RAP_ID = r.RAP_ID
    JOIN MEET_INSTC mi ON r.RAP_INSTANCE_ID = mi.MEET_INSTC_ID
    JOIN RAP_METRICS_PACK_MAPPING p ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
    JOIN RAP_MASTER_METRIC_DETAILS m
      ON p.METRICS_DISP = m.MASTER_METRIC_NAME
     AND r.RISK_TYPE_ID = m.RISK_TYPE_ID
    WHERE d.MASTER_METRIC_ID IS NULL
      AND mi.ACT_ON_RCRD = 'insert-rap-open'
) src
ON (d.ROWID = src.d_rowid)
WHEN MATCHED THEN
  UPDATE SET d.MASTER_METRIC_ID = src.MASTER_METRIC_ID;

Validation Query (Optional)

SELECT COUNT(*)
FROM RAP_METRICS_DETAILS d
JOIN RAP r ON d.RAP_ID = r.RAP_ID
JOIN MEET_INSTC mi ON r.RAP_INSTANCE_ID = mi.MEET_INSTC_ID
JOIN RAP_METRICS_PACK_MAPPING p ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
JOIN RAP_MASTER_METRIC_DETAILS m
  ON p.METRICS_DISP = m.MASTER_METRIC_NAME
 AND r.RISK_TYPE_ID = m.RISK_TYPE_ID
WHERE d.MASTER_METRIC_ID IS NULL
  AND mi.ACT_ON_RCRD = 'insert-rap-open';

Step 6: Prevent Future Duplicate RISK_TYPE_IDs and MASTER_METRIC_IDs

Add backend validation before insertions (via API or DB trigger).

Enforce uniqueness constraints or lookup logic in code.

Educate data entry teams to reuse existing headers and metrics when applicable.

Final Notes

RAP_METRICS_DETAILS now correctly references a unique and accurate MASTER_METRIC_ID.

All duplicate RISK_TYPE_IDs and MASTER_METRIC_IDs were merged using mapping tables and updates.

This ensures better data consistency, easier querying, and avoids downstream mapping issues.

