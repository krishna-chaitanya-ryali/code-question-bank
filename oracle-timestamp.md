Step 1: Find Metrics that Need to Be Inserted
sql
Copy
Edit
CREATE GLOBAL TEMPORARY TABLE METRIC_INSERT_CANDIDATES (
    METRICS_DISP VARCHAR2(3000),
    RISK_TYPE_ID NUMBER
) ON COMMIT PRESERVE ROWS;

INSERT INTO METRIC_INSERT_CANDIDATES (METRICS_DISP, RISK_TYPE_ID)
SELECT DISTINCT d.METRICS_DISP, r.RISK_TYPE_ID
FROM RAP_METRICS_DETAILS d
JOIN RAP r ON d.RAP_ID = r.RAP_ID
JOIN RAP_METRICS_PACK_MAPPING p ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
WHERE d.MASTER_METRIC_ID IS NULL
  AND d.METRICS_DISP IS NOT NULL
  AND d.METRICS_DISP != p.METRICS_DISP
  AND NOT EXISTS (
    SELECT 1 FROM RAP_MASTER_METRIC_DETAILS m
    WHERE m.MASTER_METRIC_NAME = d.METRICS_DISP AND m.RISK_TYPE_ID = r.RISK_TYPE_ID
);
ðŸ”¹ Step 2: Insert Missing Master Metrics
sql
Copy
Edit
INSERT INTO RAP_MASTER_METRIC_DETAILS (MASTER_METRIC_ID, MASTER_METRIC_NAME, RISK_TYPE_ID)
SELECT RAP_MASTER_METRIC_ID_SEQ.NEXTVAL, METRICS_DISP, RISK_TYPE_ID
FROM METRIC_INSERT_CANDIDATES;
(Replace RAP_MASTER_METRIC_ID_SEQ with your actual sequence name if different)

ðŸ”¹ Step 3: Update RAP_METRICS_DETAILS with Newly Created Master Metric IDs
sql
Copy
Edit
MERGE INTO RAP_METRICS_DETAILS d
USING (
    SELECT d.ROWID AS d_rowid, m.MASTER_METRIC_ID
    FROM RAP_METRICS_DETAILS d
    JOIN RAP r ON d.RAP_ID = r.RAP_ID
    JOIN RAP_MASTER_METRIC_DETAILS m 
      ON d.METRICS_DISP = m.MASTER_METRIC_NAME 
     AND r.RISK_TYPE_ID = m.RISK_TYPE_ID
    WHERE d.MASTER_METRIC_ID IS NULL
) src
ON (d.ROWID = src.d_rowid)
WHEN MATCHED THEN
UPDATE SET d.MASTER_METRIC_ID = src.MASTER_METRIC_ID;
