SELECT 
    d.ROWID,
    d.METRICS_DISPLAY,
    r.RISK_TYPE_ID,
    COUNT(*) AS match_count
FROM RAP_METRICS_DETAILS d
JOIN RAP r ON d.RAP_ID = r.RAP_ID
JOIN RAP_MASTER_METRIC_DETAILS m
  ON TRIM(UPPER(d.METRICS_DISPLAY)) = TRIM(UPPER(m.MASTER_METRIC_NAME))
 AND r.RISK_TYPE_ID = m.RISK_TYPE_ID
GROUP BY d.ROWID, d.METRICS_DISPLAY, r.RISK_TYPE_ID
HAVING COUNT(*) > 1;



SELECT d.ROWID, COUNT(*) 
FROM RAP_METRICS_DETAILS d
JOIN RAP r ON d.RAP_ID = r.RAP_ID
JOIN RAP_MASTER_METRIC_DETAILS m
  ON TRIM(UPPER(d.METRICS_DISPLAY)) = TRIM(UPPER(m.MASTER_METRIC_NAME))
 AND r.RISK_TYPE_ID = m.RISK_TYPE_ID
GROUP BY d.ROWID
HAVING COUNT(*) > 1;


SELECT RAP_ID, COUNT(*) 
FROM RAP
GROUP BY RAP_ID
HAVING COUNT(*) > 1;



SELECT 
    MASTER_METRIC_NAME, 
    RISK_TYPE_ID, 
    COUNT(*) 
FROM RAP_MASTER_METRIC_DETAILS
GROUP BY MASTER_METRIC_NAME, RISK_TYPE_ID
HAVING COUNT(*) > 1;

SELECT COUNT(*) 
FROM RAP_METRICS_DETAILS 
WHERE MASTER_METRIC_ID IS NULL;

SELECT COUNT(*) 
FROM RAP_METRICS_DETAILS d
JOIN RAP_MASTER_METRIC_DETAILS m
  ON d.MASTER_METRIC_ID = m.MASTER_METRIC_ID
WHERE m.MASTER_METRIC_ID > 8378;  -- IDs above the last used before today

INSERT INTO RAP_MASTER_METRIC_DETAILS (MASTER_METRIC_NAME, RISK_TYPE_ID)
SELECT DISTINCT MISSING_NAME, RISK_TYPE_ID
FROM METRIC_MISSING_INSERT;


CREATE GLOBAL TEMPORARY TABLE METRIC_MISSING_INSERT (
    MISSING_NAME VARCHAR2(3000),
    RISK_TYPE_ID NUMBER
) ON COMMIT PRESERVE ROWS;

INSERT INTO METRIC_MISSING_INSERT (MISSING_NAME, RISK_TYPE_ID)
SELECT DISTINCT
    TRIM(d.METRICS_DISPLAY),
    r.RISK_TYPE_ID
FROM
    RAP_METRICS_DETAILS d
    JOIN RAP r ON d.RAP_ID = r.RAP_ID
    JOIN RAP_METRICS_PACK_MAPPING p ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
WHERE
    TRIM(d.METRICS_DISPLAY) != TRIM(p.METRICS_DISP)
    AND d.MASTER_METRIC_ID IS NOT NULL
    AND NOT EXISTS (
        SELECT 1
        FROM RAP_MASTER_METRIC_DETAILS m
        WHERE TRIM(UPPER(m.MASTER_METRIC_NAME)) = TRIM(UPPER(d.METRICS_DISPLAY))
          AND m.RISK_TYPE_ID = r.RISK_TYPE_ID
    );
SELECT COUNT(*) FROM METRIC_MISSING_INSERT;

SELECT * FROM METRIC_MISSING_INSERT FETCH FIRST 10 ROWS ONLY;



-- Step-by-Step Implementation to Correct MASTER_METRIC_ID in RAP_METRICS_DETAILS

-- Step 1: Identify mismatched METRICS_DISPLAY vs METRICS_DISP
-- and missing MASTER_METRIC_NAME entries in RAP_MASTER_METRIC_DETAILS

CREATE GLOBAL TEMPORARY TABLE METRIC_MISSING_INSERT AS
SELECT DISTINCT d.METRICS_DISPLAY AS MISSING_NAME, r.RISK_TYPE_ID
FROM RAP_METRICS_DETAILS d
JOIN RAP r ON d.RAP_ID = r.RAP_ID
JOIN RAP_METRICS_PACK_MAPPING p ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
WHERE d.METRICS_DISPLAY != p.METRICS_DISP
  AND d.MASTER_METRIC_ID IS NOT NULL
  AND NOT EXISTS (
    SELECT 1 FROM RAP_MASTER_METRIC_DETAILS m
    WHERE m.MASTER_METRIC_NAME = d.METRICS_DISPLAY
      AND m.RISK_TYPE_ID = r.RISK_TYPE_ID
  );

-- Step 2: Insert missing entries into RAP_MASTER_METRIC_DETAILS

INSERT INTO RAP_MASTER_METRIC_DETAILS (MASTER_METRIC_ID, MASTER_METRIC_NAME, RISK_TYPE_ID)
SELECT RAP_MASTER_METRIC_DETAILS_SEQ.NEXTVAL, MISSING_NAME, RISK_TYPE_ID
FROM METRIC_MISSING_INSERT;

-- Step 3: Re-update incorrect MASTER_METRIC_IDs in RAP_METRICS_DETAILS

UPDATE RAP_METRICS_DETAILS d
SET d.MASTER_METRIC_ID = (
  SELECT m.MASTER_METRIC_ID
  FROM RAP_MASTER_METRIC_DETAILS m
  JOIN RAP r ON d.RAP_ID = r.RAP_ID
  WHERE m.MASTER_METRIC_NAME = d.METRICS_DISPLAY
    AND m.RISK_TYPE_ID = r.RISK_TYPE_ID
)
WHERE EXISTS (
  SELECT 1
  FROM RAP r, RAP_MASTER_METRIC_DETAILS m
  WHERE r.RAP_ID = d.RAP_ID
    AND m.MASTER_METRIC_NAME = d.METRICS_DISPLAY
    AND m.RISK_TYPE_ID = r.RISK_TYPE_ID
    AND d.METRICS_DISPLAY != (
      SELECT p.METRICS_DISP
      FROM RAP_METRICS_PACK_MAPPING p
      WHERE p.RAP_METRICS_MAPPING_ID = d.RAP_METRICS_MAPPING_ID
    )
);

-- Step 4: Backfill NULL MASTER_METRIC_IDs normally

MERGE INTO RAP_METRICS_DETAILS d
USING (
    SELECT
        d.ROWID AS d_rowid,
        m.MASTER_METRIC_ID
    FROM RAP_METRICS_DETAILS d
    JOIN RAP r ON d.RAP_ID = r.RAP_ID
    JOIN MEET_INSTC mi ON r.RAP_INSTANCE_ID = mi.MEET_INSTC_ID
    JOIN RAP_METRICS_PACK_MAPPING p ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
    JOIN RAP_MASTER_METRIC_DETAILS m
      ON d.METRICS_DISPLAY = m.MASTER_METRIC_NAME
     AND r.RISK_TYPE_ID = m.RISK_TYPE_ID
    WHERE d.MASTER_METRIC_ID IS NULL
      AND mi.ACT_ON_RCRD = 'insert-rap-open'
) src
ON (d.ROWID = src.d_rowid)
WHEN MATCHED THEN
UPDATE SET d.MASTER_METRIC_ID = src.MASTER_METRIC_ID;
