Step 1: Create Mapping of Duplicate Master Metric IDs
sql
Copy
Edit
CREATE GLOBAL TEMPORARY TABLE MASTER_METRIC_ID_MAPPING (
    MASTER_METRIC_NAME VARCHAR2(500),
    RISK_TYPE_ID NUMBER,
    OLD_MASTER_METRIC_ID NUMBER,
    NEW_MASTER_METRIC_ID NUMBER
) ON COMMIT PRESERVE ROWS;
sql
Copy
Edit
INSERT INTO MASTER_METRIC_ID_MAPPING (MASTER_METRIC_NAME, RISK_TYPE_ID, OLD_MASTER_METRIC_ID, NEW_MASTER_METRIC_ID)
WITH ranked AS (
    SELECT MASTER_METRIC_ID, MASTER_METRIC_NAME, RISK_TYPE_ID,
           MIN(MASTER_METRIC_ID) OVER (PARTITION BY MASTER_METRIC_NAME, RISK_TYPE_ID) AS NEW_MASTER_METRIC_ID
    FROM RAP_MASTER_METRIC_DETAILS
)
SELECT MASTER_METRIC_NAME, RISK_TYPE_ID, MASTER_METRIC_ID, NEW_MASTER_METRIC_ID
FROM ranked
WHERE MASTER_METRIC_ID != NEW_MASTER_METRIC_ID;
✅ What this does:
Maps all duplicate metric IDs (OLD) to the smallest valid one (NEW) per name + risk_type_id.

✅ Step 2: Update References in RAP_METRICS_DETAILS
sql
Copy
Edit
UPDATE RAP_METRICS_DETAILS d
SET MASTER_METRIC_ID = (
    SELECT m.NEW_MASTER_METRIC_ID
    FROM MASTER_METRIC_ID_MAPPING m
    WHERE m.OLD_MASTER_METRIC_ID = d.MASTER_METRIC_ID
)
WHERE EXISTS (
    SELECT 1 FROM MASTER_METRIC_ID_MAPPING m
    WHERE m.OLD_MASTER_METRIC_ID = d.MASTER_METRIC_ID
);
✅ Ensures that all references now point to the surviving (minimal) MASTER_METRIC_ID.

✅ Step 3: Delete True Duplicate Rows from RAP_MASTER_METRIC_DETAILS
sql
Copy
Edit
DELETE FROM RAP_MASTER_METRIC_DETAILS
WHERE MASTER_METRIC_ID IN (
    SELECT OLD_MASTER_METRIC_ID FROM MASTER_METRIC_ID_MAPPING
);
✅ Cleans the duplicates, leaving one valid copy for each name + risk_type.

Optional: Confirm Before and After
sql
Copy
Edit
-- BEFORE (confirm duplicates)
SELECT MASTER_METRIC_NAME, RISK_TYPE_ID, COUNT(*)
FROM RAP_MASTER_METRIC_DETAILS
GROUP BY MASTER_METRIC_NAME, RISK_TYPE_ID
HAVING COUNT(*) > 1;

-- AFTER (should return 0 rows)
-- Run the same query after deletion
