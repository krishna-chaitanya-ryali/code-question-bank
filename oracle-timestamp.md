1. Identify METRICS_DISPLAY in RAP_METRICS_DETAILS that are not yet present in RAP_MASTER_METRIC_DETAILS
sql
Copy
Edit
-- Step 1: Create a temporary table to hold missing metric names
CREATE GLOBAL TEMPORARY TABLE METRIC_MISSING_INSERT (
    METRICS_DISPLAY VARCHAR2(500),
    RISK_TYPE_ID NUMBER,
    MASTER_METRIC_ID NUMBER
) ON COMMIT PRESERVE ROWS;
2. Populate the missing metric names
sql
Copy
Edit
-- Step 2: Insert missing METRICS_DISPLAY values into temp table
INSERT INTO METRIC_MISSING_INSERT (METRICS_DISPLAY, RISK_TYPE_ID)
SELECT DISTINCT d.METRICS_DISPLAY, r.RISK_TYPE_ID
FROM RAP_METRICS_DETAILS d
JOIN RAP r ON d.RAP_ID = r.RAP_ID
JOIN RAP_METRICS_PACK_MAPPING p ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
WHERE d.METRICS_DISPLAY != p.METRICS_DISP
  AND NOT EXISTS (
      SELECT 1 FROM RAP_MASTER_METRIC_DETAILS m
      WHERE m.MASTER_METRIC_NAME = d.METRICS_DISPLAY
  );
3. Insert the new records into RAP_MASTER_METRIC_DETAILS
sql
Copy
Edit
-- Step 3: Insert new rows into RAP_MASTER_METRIC_DETAILS
INSERT INTO RAP_MASTER_METRIC_DETAILS (MASTER_METRIC_ID, MASTER_METRIC_NAME, RISK_TYPE_ID)
SELECT RAP_MASTER_METRIC_DETAILS_SEQ.NEXTVAL, METRICS_DISPLAY, RISK_TYPE_ID
FROM METRIC_MISSING_INSERT;
4. Update RAP_METRICS_DETAILS with the correct MASTER_METRIC_ID
sql
Copy
Edit
-- Step 4: Update RAP_METRICS_DETAILS with newly inserted MASTER_METRIC_IDs
UPDATE RAP_METRICS_DETAILS d
SET d.MASTER_METRIC_ID = (
    SELECT m.MASTER_METRIC_ID
    FROM RAP_MASTER_METRIC_DETAILS m
    WHERE m.MASTER_METRIC_NAME = d.METRICS_DISPLAY
      AND m.RISK_TYPE_ID = (
          SELECT r.RISK_TYPE_ID FROM RAP r WHERE r.RAP_ID = d.RAP_ID
      )
)
WHERE EXISTS (
    SELECT 1 FROM RAP_MASTER_METRIC_DETAILS m
    WHERE m.MASTER_METRIC_NAME = d.METRICS_DISPLAY
      AND m.RISK_TYPE_ID = (
          SELECT r.RISK_TYPE_ID FROM RAP r WHERE r.RAP_ID = d.RAP_ID
      )
);
