SELECT *
FROM RAP_MASTER_METRIC_DETAILS
WHERE (MASTER_METRIC_NAME, RISK_TYPE_ID) IN (
    SELECT MASTER_METRIC_NAME, RISK_TYPE_ID
    FROM RAP_MASTER_METRIC_DETAILS
    GROUP BY MASTER_METRIC_NAME, RISK_TYPE_ID
    HAVING COUNT(*) > 1
)
ORDER BY MASTER_METRIC_NAME, RISK_TYPE_ID, MASTER_METRIC_ID;



SELECT DISTINCT 
    p.METRICS_DISP AS METRIC_NAME,
    r.RISK_TYPE_ID AS RAP_RISK_TYPE_ID,
    m.RISK_TYPE_ID AS MASTER_RISK_TYPE_ID,
    m.MASTER_METRIC_ID
FROM RAP_METRICS_DETAILS d
JOIN RAP r ON d.RAP_ID = r.RAP_ID
JOIN MEET_INSTC mi ON r.RAP_INSTANCE_ID = mi.MEET_INSTC_ID
JOIN RAP_METRICS_PACK_MAPPING p ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
JOIN RAP_MASTER_METRIC_DETAILS m ON m.MASTER_METRIC_NAME = p.METRICS_DISP
WHERE d.MASTER_METRIC_ID IS NULL
  AND mi.ACT_ON_RCRD = 'insert-rap-open'
  AND m.RISK_TYPE_ID != r.RISK_TYPE_ID;


UPDATE RAP_MASTER_METRIC_DETAILS m
SET m.RISK_TYPE_ID = (
    SELECT DISTINCT r.RISK_TYPE_ID
    FROM RAP_METRICS_DETAILS d
    JOIN RAP r ON d.RAP_ID = r.RAP_ID
    JOIN MEET_INSTC mi ON r.RAP_INSTANCE_ID = mi.MEET_INSTC_ID
    JOIN RAP_METRICS_PACK_MAPPING p ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
    WHERE d.MASTER_METRIC_ID IS NULL
      AND mi.ACT_ON_RCRD = 'insert-rap-open'
      AND p.METRICS_DISP = m.MASTER_METRIC_NAME
      AND ROWNUM = 1
)
WHERE EXISTS (
    SELECT 1
    FROM RAP_METRICS_DETAILS d
    JOIN RAP r ON d.RAP_ID = r.RAP_ID
    JOIN MEET_INSTC mi ON r.RAP_INSTANCE_ID = mi.MEET_INSTC_ID
    JOIN RAP_METRICS_PACK_MAPPING p ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
    WHERE d.MASTER_METRIC_ID IS NULL
      AND mi.ACT_ON_RCRD = 'insert-rap-open'
      AND p.METRICS_DISP = m.MASTER_METRIC_NAME
      AND m.RISK_TYPE_ID != r.RISK_TYPE_ID
);
