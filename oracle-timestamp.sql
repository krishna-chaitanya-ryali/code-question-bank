SELECT
  d.METRIC_DETAIL_ID,
  d.RAP_METRICS_MAPPING_ID,
  d.MASTER_METRIC_ID AS OLD_MASTER_METRIC_ID,
  COALESCE(ffill, bfill) AS NEW_MASTER_METRIC_ID
FROM (
  SELECT
    d2.METRIC_DETAIL_ID,
    d2.RAP_METRICS_MAPPING_ID,
    d2.MASTER_METRIC_ID,
    LAST_VALUE(m.MASTER_METRIC_ID IGNORE NULLS)
      OVER (PARTITION BY p.RAP_METRICS_MAPPING_ID
            ORDER BY d2.METRIC_DETAIL_ID
            ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ffill,
    FIRST_VALUE(m.MASTER_METRIC_ID IGNORE NULLS)
      OVER (PARTITION BY p.RAP_METRICS_MAPPING_ID
            ORDER BY d2.METRIC_DETAIL_ID
            ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) AS bfill
  FROM RAP_METRICS_DETAILS d2
  JOIN RAP r2
    ON r2.RAP_ID = d2.RAP_ID
  JOIN RAP_METRICS_PACK_MAPPING p
    ON d2.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
  JOIN RAP_MASTER_METRIC_DETAILS m
    ON TRIM(UPPER(p.METRICS_DISP)) = TRIM(UPPER(m.MASTER_METRIC_NAME))
  JOIN MEET_INSTC mi2
    ON r2.RAP_INSTANCE_ID = mi2.MEET_INSTC_ID
  WHERE mi2.ACTONRCRD = 'insert-rap-open'
    AND mi2.MEET_INSTC_ID = 11558
    AND p.RAP_METRICS_MAPPING_ID = 25   -- âœ… new condition added
) t
JOIN RAP_METRICS_DETAILS d
  ON d.METRIC_DETAIL_ID = t.METRIC_DETAIL_ID
WHERE d.MASTER_METRIC_ID IS NULL
  AND EXISTS (
    SELECT 1
    FROM RAP r3
    JOIN MEET_INSTC mi3
      ON r3.RAP_INSTANCE_ID = mi3.MEET_INSTC_ID
    WHERE r3.RAP_ID = d.RAP_ID
      AND mi3.MEET_INSTC_ID = 11558
      AND mi3.ACTONRCRD = 'insert-rap-open'
  )
ORDER BY d.RAP_METRICS_MAPPING_ID, d.METRIC_DETAIL_ID;
