CREATE GLOBAL TEMPORARY TABLE MASTER_METRIC_ID_MAPPING
(
    OLD_MASTER_METRIC_ID NUMBER,
    NEW_MASTER_METRIC_ID NUMBER
) ON COMMIT PRESERVE ROWS;

INSERT INTO MASTER_METRIC_ID_MAPPING (OLD_MASTER_METRIC_ID, NEW_MASTER_METRIC_ID)
SELECT MASTER_METRIC_ID AS OLD_ID,
       MIN(MASTER_METRIC_ID) OVER (
           PARTITION BY TRIM(UPPER(REGEXP_REPLACE(MASTER_METRIC_NAME, '\s+', ' '))),
                        RISK_TYPE_ID
       ) AS NEW_ID
FROM RAP_MASTER_METRIC_DETAILS
WHERE MASTER_METRIC_ID IS NOT NULL
  AND TRIM(UPPER(REGEXP_REPLACE(MASTER_METRIC_NAME, '\s+', ' '))) IS NOT NULL
  AND MASTER_METRIC_ID <> MIN(MASTER_METRIC_ID) OVER (
           PARTITION BY TRIM(UPPER(REGEXP_REPLACE(MASTER_METRIC_NAME, '\s+', ' '))),
                        RISK_TYPE_ID
       )
;


UPDATE RAP_METRICS_DETAILS d
SET MASTER_METRIC_ID = (
    SELECT NEW_MASTER_METRIC_ID
    FROM MASTER_METRIC_ID_MAPPING m
    WHERE m.OLD_MASTER_METRIC_ID = d.MASTER_METRIC_ID
)
WHERE EXISTS (
    SELECT 1
    FROM MASTER_METRIC_ID_MAPPING m
    WHERE m.OLD_MASTER_METRIC_ID = d.MASTER_METRIC_ID
);


DELETE FROM RAP_MASTER_METRIC_DETAILS
WHERE MASTER_METRIC_ID IN (
    SELECT OLD_MASTER_METRIC_ID
    FROM MASTER_METRIC_ID_MAPPING
);
