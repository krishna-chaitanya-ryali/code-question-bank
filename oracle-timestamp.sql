SELECT DISTINCT d.MASTER_METRIC_ID,
       r.RISK_TYPE_ID,
       p.METRICS_DISP AS EXPECTED_NAME
FROM RAP_METRICS_DETAILS d
JOIN RAP r 
  ON d.RAP_ID = r.RAP_ID
JOIN RAP_METRICS_PACK_MAPPING p
  ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
WHERE NOT EXISTS (
    SELECT 1
    FROM RAP_MASTER_METRIC_DETAILS m
    WHERE m.MASTER_METRIC_ID = d.MASTER_METRIC_ID
);


SELECT m.MASTER_METRIC_ID,
       m.MASTER_METRIC_NAME AS OLD_MASTER_NAME,
       p.METRICS_DISP       AS NEW_MASTER_NAME,
       m.RISK_TYPE_ID,
       d.RAP_METRICS_MAPPING_ID
FROM RAP_MASTER_METRIC_DETAILS m
JOIN RAP_METRICS_DETAILS d
  ON d.MASTER_METRIC_ID = m.MASTER_METRIC_ID
JOIN RAP r 
  ON d.RAP_ID = r.RAP_ID
JOIN RAP_METRICS_PACK_MAPPING p
  ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
WHERE r.RISK_TYPE_ID = m.RISK_TYPE_ID
  AND m.MASTER_METRIC_NAME <> p.METRICS_DISP;


UPDATE RAP_MASTER_METRIC_DETAILS m
SET m.MASTER_METRIC_NAME = (
        SELECT p.METRICS_DISP
        FROM RAP_METRICS_DETAILS d
        JOIN RAP r 
          ON d.RAP_ID = r.RAP_ID
        JOIN RAP_METRICS_PACK_MAPPING p
          ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
        WHERE d.MASTER_METRIC_ID = m.MASTER_METRIC_ID
          AND r.RISK_TYPE_ID = m.RISK_TYPE_ID
          AND m.MASTER_METRIC_NAME <> p.METRICS_DISP
          FETCH FIRST 1 ROWS ONLY
)
WHERE EXISTS (
    SELECT 1
    FROM RAP_METRICS_DETAILS d
    JOIN RAP r 
      ON d.RAP_ID = r.RAP_ID
    JOIN RAP_METRICS_PACK_MAPPING p
      ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
    WHERE d.MASTER_METRIC_ID = m.MASTER_METRIC_ID
      AND r.RISK_TYPE_ID = m.RISK_TYPE_ID
      AND m.MASTER_METRIC_NAME <> p.METRICS_DISP
);
