UPDATE RAP_METRICS_DETAILS d
SET d.MASTER_METRIC_ID = (
  SELECT COALESCE(ffill, bfill)
  FROM (
    SELECT
      d2.METRIC_DETAIL_ID,
      -- forward fill: take last non-null going down
      LAST_VALUE(m.MASTER_METRIC_ID IGNORE NULLS)
        OVER (PARTITION BY p.RAP_METRICS_MAPPING_ID
              ORDER BY d2.METRIC_DETAIL_ID
              ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS ffill,
      -- backward fill: take next non-null going up
      FIRST_VALUE(m.MASTER_METRIC_ID IGNORE NULLS)
        OVER (PARTITION BY p.RAP_METRICS_MAPPING_ID
              ORDER BY d2.METRIC_DETAIL_ID
              ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) AS bfill
    FROM RAP_METRICS_DETAILS d2
    JOIN RAP r2
      ON r2.RAP_ID = d2.RAP_ID
    JOIN RAP_METRICS_PACK_MAPPING p
      ON d2.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
    JOIN RAP_MASTER_METRIC_DETAILS m
      ON TRIM(UPPER(p.METRICS_DISP)) = TRIM(UPPER(m.MASTER_METRIC_NAME))
    JOIN MEET_INSTC mi2
      ON r2.MEET_INSTC_ID = mi2.MEET_INSTC_ID
    WHERE m.ACT_OF_RCRD = 'insert-rap-open'
      AND mi2.MEET_INSTC_ID = 11558
  ) t
  WHERE t.METRIC_DETAIL_ID = d.METRIC_DETAIL_ID
)
WHERE d.MASTER_METRIC_ID IS NULL
  AND EXISTS (
    SELECT 1
    FROM RAP r3
    JOIN MEET_INSTC mi3
      ON r3.MEET_INSTC_ID = mi3.MEET_INSTC_ID
    WHERE r3.RAP_ID = d.RAP_ID
      AND mi3.MEET_INSTC_ID = 11558
      AND r3.ACT_OF_RCRD = 'insert-rap-open'
  );
