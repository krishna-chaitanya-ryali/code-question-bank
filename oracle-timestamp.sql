SELECT d.ROWID AS d_rowid,
       d.METRICS_DISPLAY,
       p.METRICS_DISP,
       mi.RISK_TYPE_ID,
       m.MASTER_METRIC_NAME,
       m.MASTER_METRIC_ID,
       CASE
           WHEN mi.RISK_TYPE_ID = m.RISK_TYPE_ID THEN 'RISK_TYPE_ID match'
           WHEN UPPER(d.METRICS_DISPLAY) = UPPER(m.MASTER_METRIC_NAME) THEN 'METRICS_DISPLAY match'
           WHEN UPPER(p.METRICS_DISP) = UPPER(m.MASTER_METRIC_NAME) THEN 'METRICS_DISP match'
           ELSE 'No match'
       END AS MATCH_REASON
FROM RAP_METRICS_DETAILS d
JOIN MEET_INSTC mi
    ON d.RAP_INSTANCE_ID = mi.MEET_INSTC_ID
JOIN RAP_METRICS_PACK_MAPPING p
    ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
JOIN RAP_MASTER_METRIC_DETAILS m
    ON (
           mi.RISK_TYPE_ID = m.RISK_TYPE_ID
        OR UPPER(d.METRICS_DISPLAY) = UPPER(m.MASTER_METRIC_NAME)
        OR UPPER(p.METRICS_DISP)   = UPPER(m.MASTER_METRIC_NAME)
    )
WHERE d.MASTER_METRIC_ID IS NULL;
