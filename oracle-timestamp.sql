SELECT 
    TRIM(UPPER(REGEXP_REPLACE(MASTER_METRIC_NAME, '\s+', ' '))) AS NORMALIZED_NAME,
    RISK_TYPE_ID,
    COUNT(*) AS TOTAL_COUNT,
    LISTAGG(MASTER_METRIC_ID, ', ') WITHIN GROUP (ORDER BY MASTER_METRIC_ID) AS METRIC_IDS
FROM RAP_MASTER_METRIC_DETAILS
GROUP BY TRIM(UPPER(REGEXP_REPLACE(MASTER_METRIC_NAME, '\s+', ' '))), RISK_TYPE_ID
HAVING COUNT(*) > 1
ORDER BY NORMALIZED_NAME, RISK_TYPE_ID;

DELETE FROM RAP_MASTER_METRIC_DETAILS
WHERE MASTER_METRIC_ID IN (
    SELECT MASTER_METRIC_ID
    FROM (
        SELECT MASTER_METRIC_ID,
               ROW_NUMBER() OVER (
                   PARTITION BY TRIM(UPPER(REGEXP_REPLACE(MASTER_METRI

DELETE FROM RAP_MASTER_METRIC_DETAILS
WHERE MASTER_METRIC_ID IN (
    SELECT MASTER_METRIC_ID
    FROM (
        SELECT MASTER_METRIC_ID,
               ROW_NUMBER() OVER (
                   PARTITION BY TRIM(UPPER(REGEXP_REPLACE(MASTER_METRIC_NAME, '\s+', ' '))), RISK_TYPE_ID
                   ORDER BY MASTER_METRIC_ID
               ) AS rn
        FROM RAP_MASTER_METRIC_DETAILS
    )
    WHERE rn > 1
);
