UPDATE RAP_METRICS_DETAILS d
SET d.MASTER_METRIC_ID = (
    SELECT MIN(m.MASTER_METRIC_ID)  -- pick smallest ID if multiple match
    FROM RAP_MEET_INSTC mi
    JOIN RAP_METRICS_PACK_MAPPING g 
        ON g.MEET_INSTC_ID = mi.MEET_INSTC_ID
    JOIN RAP_METRICS_MAPPING p
        ON p.RAP_METRICS_MAPPING_ID = g.RAP_METRICS_MAPPING_ID
    JOIN RAP_MASTER_METRIC_DETAILS m
        ON TRIM(UPPER(m.MASTER_METRIC_NAME)) = TRIM(UPPER(d.METRICS_DISPLAY))
    WHERE d.RAP_ID = mi.RAP_ID
      AND p.RAP_METRICS_MAPPING_ID = m.RAP_METRICS_MAPPING_ID
      AND d.MASTER_METRIC_ID IS NULL
      AND mi.ACT_ON_RCRD = 'insert-rap-open'
      AND mi.MEET_INSTC_ID = 11558
      AND EXISTS (
          SELECT 1
          FROM RAP_MEET_INSTC mi2
          WHERE mi2.RAP_INSTANCE_ID = mi2.MEET_INSTC_ID
            AND mi2.ACT_ON_RCRD = 'insert-rap-open'
            AND mi2.MEET_INSTC_ID = 11558
      )
)
WHERE d.MASTER_METRIC_ID IS NULL;



INSERT INTO MASTER_METRIC_ID_MAPPING (OLD_MASTER_METRIC_ID, NEW_MASTER_METRIC_ID)
SELECT OLD_ID, NEW_ID
FROM (
    SELECT MASTER_METRIC_ID AS OLD_ID,
           MIN(MASTER_METRIC_ID) OVER (
               PARTITION BY TRIM(UPPER(REGEXP_REPLACE(MASTER_METRIC_NAME, '\s+', ' '))),
                            RISK_TYPE_ID
           ) AS NEW_ID
    FROM RAP_MASTER_METRIC_DETAILS
    WHERE MASTER_METRIC_ID IS NOT NULL
      AND TRIM(UPPER(REGEXP_REPLACE(MASTER_METRIC_NAME, '\s+', ' '))) IS NOT NULL
) t
WHERE OLD_ID <> NEW_ID;


CREATE GLOBAL TEMPORARY TABLE MASTER_METRIC_ID_MAPPING
(
    OLD_MASTER_METRIC_ID NUMBER,
    NEW_MASTER_METRIC_ID NUMBER
) ON COMMIT PRESERVE ROWS;

INSERT INTO MASTER_METRIC_ID_MAPPING (OLD_MASTER_METRIC_ID, NEW_MASTER_METRIC_ID)
SELECT MASTER_METRIC_ID AS OLD_ID,
       MIN(MASTER_METRIC_ID) OVER (
           PARTITION BY TRIM(UPPER(REGEXP_REPLACE(MASTER_METRIC_NAME, '\s+', ' '))),
                        RISK_TYPE_ID
       ) AS NEW_ID
FROM RAP_MASTER_METRIC_DETAILS
WHERE MASTER_METRIC_ID IS NOT NULL
  AND TRIM(UPPER(REGEXP_REPLACE(MASTER_METRIC_NAME, '\s+', ' '))) IS NOT NULL
  AND MASTER_METRIC_ID <> MIN(MASTER_METRIC_ID) OVER (
           PARTITION BY TRIM(UPPER(REGEXP_REPLACE(MASTER_METRIC_NAME, '\s+', ' '))),
                        RISK_TYPE_ID
       )
;


UPDATE RAP_METRICS_DETAILS d
SET MASTER_METRIC_ID = (
    SELECT NEW_MASTER_METRIC_ID
    FROM MASTER_METRIC_ID_MAPPING m
    WHERE m.OLD_MASTER_METRIC_ID = d.MASTER_METRIC_ID
)
WHERE EXISTS (
    SELECT 1
    FROM MASTER_METRIC_ID_MAPPING m
    WHERE m.OLD_MASTER_METRIC_ID = d.MASTER_METRIC_ID
);


DELETE FROM RAP_MASTER_METRIC_DETAILS
WHERE MASTER_METRIC_ID IN (
    SELECT OLD_MASTER_METRIC_ID
    FROM MASTER_METRIC_ID_MAPPING
);
