SELECT 
    p.RAP_METRICS_PACK_MAPPING_ID,
    COUNT(DISTINCT d.MASTER_METRIC_ID) AS MASTER_METRIC_COUNT,
    LISTAGG(DISTINCT d.MASTER_METRIC_ID, ', ') 
        WITHIN GROUP (ORDER BY d.MASTER_METRIC_ID) AS MASTER_METRIC_IDS
FROM RAP_METRICS_DETAILS d
JOIN RAP_METRICS_PACK_MAPPING p 
    ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
JOIN RAP_MASTER_METRIC_DETAILS m
    ON TRIM(UPPER(p.METRICS_DISP)) = TRIM(UPPER(m.MASTER_METRIC_NAME))
WHERE d.MASTER_METRIC_ID IS NOT NULL
GROUP BY p.RAP_METRICS_PACK_MAPPING_ID
HAVING COUNT(DISTINCT d.MASTER_METRIC_ID) > 1
ORDER BY MASTER_METRIC_COUNT DESC;


SELECT 
    p.RAP_METRICS_MAPPING_ID,
    r.RISK_TYPE_ID                         AS RAP_RISK_TYPE_ID,
    rr.RISK_HEADER                         AS RAP_RISK_HEADER,
    m.RISK_TYPE_ID                         AS MASTER_METRIC_RISK_TYPE_ID,
    rrm.RISK_HEADER                        AS MASTER_METRIC_RISK_HEADER,
    COUNT(DISTINCT d.MASTER_METRIC_ID)     AS MASTER_METRIC_COUNT,
    LISTAGG(DISTINCT d.MASTER_METRIC_ID, ', ')
        WITHIN GROUP (ORDER BY d.MASTER_METRIC_ID) AS MASTER_METRIC_IDS
FROM RAP_METRICS_DETAILS d
JOIN RAP r 
  ON d.RAP_ID = r.RAP_ID                -- get RAP's risk type
JOIN RAP_METRICS_PACK_MAPPING p 
  ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
JOIN RAP_MASTER_METRIC_DETAILS m
  ON m.MASTER_METRIC_ID = d.MASTER_METRIC_ID  -- get master's risk type (by ID to avoid name duplicates)
LEFT JOIN RAP_RISK_TYPE rr
  ON rr.RISK_TYPE_ID = r.RISK_TYPE_ID
LEFT JOIN RAP_RISK_TYPE rrm
  ON rrm.RISK_TYPE_ID = m.RISK_TYPE_ID
WHERE d.MASTER_METRIC_ID IS NOT NULL
GROUP BY 
    p.RAP_METRICS_MAPPING_ID,
    r.RISK_TYPE_ID, rr.RISK_HEADER,
    m.RISK_TYPE_ID, rrm.RISK_HEADER
HAVING COUNT(DISTINCT d.MASTER_METRIC_ID) > 1
ORDER BY MASTER_METRIC_COUNT DESC, p.RAP_METRICS_MAPPING_ID;

