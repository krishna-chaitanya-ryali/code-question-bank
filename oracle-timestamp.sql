-- Step 1: Create missing master metrics
INSERT INTO RAP_MASTER_METRIC_DETAILS (
    MASTER_METRIC_NAME,
    RISK_TYPE_ID,
    CREATE_DT,
    UPDT_DT
)
SELECT p.METRICS_DISP,
       r.RISK_TYPE_ID,
       SYSTIMESTAMP,
       SYSTIMESTAMP
FROM RAP_METRICS_DETAILS d
JOIN RAP r 
    ON d.RAP_ID = r.RAP_ID
JOIN MEET_INSTC mi 
    ON r.RAP_INSTANCE_ID = mi.MEET_INSTC_ID
JOIN RAP_METRICS_PACK_MAPPING p 
    ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
LEFT JOIN RAP_MASTER_METRIC_DETAILS m
    ON UPPER(p.METRICS_DISP) = UPPER(m.MASTER_METRIC_NAME)
   AND r.RISK_TYPE_ID = m.RISK_TYPE_ID
WHERE d.MASTER_METRIC_ID IS NULL
  AND m.MASTER_METRIC_ID IS NULL
  AND mi.ACT_ON_RCRD = 'insert-rap-open'
  AND mi.MEET_INSTC_ID = 11657;

-- Step 2: Backfill MASTER_METRIC_ID
-- Step 2: Backfill MASTER_METRIC_ID
WITH existing_master_ids AS (
    SELECT RAP_METRICS_MAPPING_ID,
           MAX(MASTER_METRIC_ID) AS MASTER_METRIC_ID
    FROM RAP_METRICS_DETAILS
    WHERE MASTER_METRIC_ID IS NOT NULL
    GROUP BY RAP_METRICS_MAPPING_ID
)
UPDATE RAP_METRICS_DETAILS d
SET MASTER_METRIC_ID = (
    SELECT COALESCE(emi.MASTER_METRIC_ID, m.MASTER_METRIC_ID)
    FROM RAP r
    JOIN MEET_INSTC mi 
        ON r.RAP_INSTANCE_ID = mi.MEET_INSTC_ID
    JOIN RAP_METRICS_PACK_MAPPING p 
        ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
    LEFT JOIN existing_master_ids emi
        ON d.RAP_METRICS_MAPPING_ID = emi.RAP_METRICS_MAPPING_ID
    LEFT JOIN RAP_MASTER_METRIC_DETAILS m
        ON UPPER(p.METRICS_DISP) = UPPER(m.MASTER_METRIC_NAME)
    WHERE d.RAP_ID = r.RAP_ID
      AND d.MASTER_METRIC_ID IS NULL
      AND mi.ACT_ON_RCRD = 'insert-rap-open'
      AND mi.MEET_INSTC_ID = 11657
)
WHERE MASTER_METRIC_ID IS NULL;




WITH existing_master_ids AS (
    SELECT RAP_METRICS_MAPPING_ID,
           MAX(MASTER_METRIC_ID) AS MASTER_METRIC_ID
    FROM RAP_METRICS_DETAILS
    WHERE MASTER_METRIC_ID IS NOT NULL
    GROUP BY RAP_METRICS_MAPPING_ID
)
SELECT d.ROWID AS d_rowid,
       d.METRIC_DETAIL_ID,
       d.RAP_ID,
       d.RAP_METRICS_MAPPING_ID,
       d.METRICS_DISPLAY,
       p.METRICS_DISP,
       r.RISK_TYPE_ID,
       emi.MASTER_METRIC_ID AS master_from_mapping,
       m.MASTER_METRIC_ID   AS master_from_name,
       COALESCE(emi.MASTER_METRIC_ID, m.MASTER_METRIC_ID) AS mapped_master_metric_id
FROM RAP_METRICS_DETAILS d
JOIN RAP r 
    ON d.RAP_ID = r.RAP_ID
JOIN MEET_INSTC mi 
    ON r.RAP_INSTANCE_ID = mi.MEET_INSTC_ID
JOIN RAP_METRICS_PACK_MAPPING p 
    ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
LEFT JOIN existing_master_ids emi
    ON d.RAP_METRICS_MAPPING_ID = emi.RAP_METRICS_MAPPING_ID
LEFT JOIN RAP_MASTER_METRIC_DETAILS m
    ON UPPER(p.METRICS_DISP) = UPPER(m.MASTER_METRIC_NAME)
   AND r.RISK_TYPE_ID = m.RISK_TYPE_ID
WHERE d.MASTER_METRIC_ID IS NULL
  AND mi.ACT_ON_RCRD = 'insert-rap-open'
  AND mi.MEET_INSTC_ID = 11657
ORDER BY d.METRIC_DETAIL_ID;
