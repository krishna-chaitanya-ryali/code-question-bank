SELECT d.METRIC_DETAIL_ID,
       d.RAP_ID,
       d.RAP_METRICS_MAPPING_ID,
       d.METRICS_DISPLAY,
       COALESCE(d.MASTER_METRIC_ID, mm.MASTER_METRIC_ID) AS resolved_master_metric_id
FROM RAP_METRICS_DETAILS d
LEFT JOIN (
    SELECT RAP_METRICS_MAPPING_ID,
           MAX(MASTER_METRIC_ID) AS MASTER_METRIC_ID
    FROM RAP_METRICS_DETAILS
    WHERE MASTER_METRIC_ID IS NOT NULL
    GROUP BY RAP_METRICS_MAPPING_ID
) mm
    ON d.RAP_METRICS_MAPPING_ID = mm.RAP_METRICS_MAPPING_ID
WHERE d.MASTER_METRIC_ID IS NULL;
