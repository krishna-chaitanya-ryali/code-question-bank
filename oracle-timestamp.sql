SELECT 
    p.RAP_METRICS_PACK_MAPPING_ID,
    COUNT(DISTINCT d.MASTER_METRIC_ID) AS MASTER_METRIC_COUNT,
    LISTAGG(DISTINCT d.MASTER_METRIC_ID, ', ') 
        WITHIN GROUP (ORDER BY d.MASTER_METRIC_ID) AS MASTER_METRIC_IDS
FROM RAP_METRICS_DETAILS d
JOIN RAP_METRICS_PACK_MAPPING p 
    ON d.RAP_METRICS_MAPPING_ID = p.RAP_METRICS_MAPPING_ID
JOIN RAP_MASTER_METRIC_DETAILS m
    ON TRIM(UPPER(p.METRICS_DISP)) = TRIM(UPPER(m.MASTER_METRIC_NAME))
WHERE d.MASTER_METRIC_ID IS NOT NULL
GROUP BY p.RAP_METRICS_PACK_MAPPING_ID
HAVING COUNT(DISTINCT d.MASTER_METRIC_ID) > 1
ORDER BY MASTER_METRIC_COUNT DESC;
