SELECT 
    TRIM(UPPER(MASTER_METRIC_NAME)) AS METRIC_NAME,
    RISK_TYPE_ID,
    COUNT(DISTINCT MASTER_METRIC_ID) AS METRIC_ID_COUNT,
    LISTAGG(MASTER_METRIC_ID, ', ') WITHIN GROUP (ORDER BY MASTER_METRIC_ID) AS METRIC_IDS
FROM RAP_MASTER_METRIC_DETAILS
GROUP BY TRIM(UPPER(MASTER_METRIC_NAME)), RISK_TYPE_ID
HAVING COUNT(DISTINCT MASTER_METRIC_ID) > 1
ORDER BY METRIC_NAME, RISK_TYPE_ID;
