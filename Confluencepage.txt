def process_lm_recertification():
    """
    Line Manager–driven user recertification job.

    This scheduler runs periodically (hourly) to process user access
    revocation decisions made by Line Managers.

    Workflow:
    1. Fetch records from RECREATE_RESPONSE where access is marked as REVOKE.
    2. Validate revoke date (ACCESS_REVOKED_DATE_BY_LINE_MANAGER).
    3. If revoke date is reached or passed:
       - Deactivate metric-level access for the user.
       - Deactivate user–RMM role mapping.
       - Mark the RECREATE_RESPONSE record as processed.
    4. Skip records scheduled for future revoke dates.

    This function is idempotent and safe to re-run.
    """


def process_lm_recertification():
    """
    Line Manager–driven user recertification job.

    This scheduler runs periodically (hourly) to process user access
    revocation decisions made by Line Managers.

    Workflow:
    1. Fetch records from RECREATE_RESPONSE where access is marked as REVOKE.
    2. Validate revoke date (ACCESS_REVOKED_DATE_BY_LINE_MANAGER).
    3. If revoke date is reached or passed:
       - Deactivate metric-level access for the user.
       - Deactivate user–RMM role mapping.
       - Mark the RECREATE_RESPONSE record as processed.
    4. Skip records scheduled for future revoke dates.

    This function is idempotent and safe to re-run.
    """

def revoke_user_access(cursor, user_id, rmm_id):
    """
    Revokes user access for a specific RMM.

    This function performs a soft-revocation (no deletes) by:
    1. Identifying all metric_detail_ids associated with the user
       for the given RMM and current month.
    2. Deactivating all corresponding rows in METRIC_ACCESS.
    3. Deactivating the user–RMM mapping in MAP_RAP_USER_ROLE.

    Parameters:
    - cursor : Active database cursor
    - user_id : User identifier whose access is being revoked
    - rmm_id  : RMM identifier for which access is revoked

    The operation is transactional and safe for repeated execution.
    """
def revoke_user_access(cursor, user_id, rmm_id):
    """
    Revokes user access for a specific RMM.

    This function performs a soft-revocation (no deletes) by:
    1. Identifying all metric_detail_ids associated with the user
       for the given RMM and current month.
    2. Deactivating all corresponding rows in METRIC_ACCESS.
    3. Deactivating the user–RMM mapping in MAP_RAP_USER_ROLE.

    Parameters:
    - cursor : Active database cursor
    - user_id : User identifier whose access is being revoked
    - rmm_id  : RMM identifier for which access is revoked

    The operation is transactional and safe for repeated execution.
    """
def sqlupdatedata(self, query_key, param):
    """
    Generic SQL update dispatcher.

    Retrieves the SQL statement using the query key and
    delegates execution to bulk_update_data.

    Supports:
    - Single-row updates (dict)
    - Bulk updates (list of dicts)

    Parameters:
    - query_key : Key to fetch SQL from QueryString
    - param     : Bind parameters (dict or list of dicts)

    This function abstracts SQL execution while maintaining
    consistency with the project's DB access pattern.
    """


@recert_bp.route("/trigger-recertification", methods=["POST"])
def manual_trigger_recertification():
    """
    Manual trigger endpoint for user recertification jobs.

    Accepts a trigger_type parameter to execute:
    - 'LM'     → Line Manager–driven recertification
    - 'SYSTEM' → System-driven recertification

    This endpoint is intended for UAT testing and
    administrative intervention only.
    """

    data = request.get_json()
    trigger_type = data.get("trigger_type")

    if trigger_type == "LM":
        process_lm_recertification()
        return jsonify({"status": "LM recertification triggered successfully"})

    elif trigger_type == "SYSTEM":
        process_system_recertification()
        return jsonify({"status": "System recertification triggered successfully"})

    else:
        return jsonify({
            "error": "Invalid trigger_type. Use 'LM' or 'SYSTEM'."
        }), 400
