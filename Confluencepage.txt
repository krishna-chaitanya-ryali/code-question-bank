SELECT
    ma.metric_access_id,
    mrur.user_id,
    mrur.rmm_id,
    mrur.rap_user_role_id   AS correct_user_role_id,
    ma.user_role_id         AS existing_user_role_id
FROM user_tab ut
JOIN map_rap_user_role mrur
    ON ut.user_id = mrur.user_id
JOIN metric_access ma
    ON mrur.user_id = ma.user_id
JOIN rap_metrics_details rmd
    ON ma.metric_detail_id = rmd.metric_detail_id
JOIN rap_rmm_group rrg
    ON mrur.rmm_id = rrg.rmm_id
JOIN rap_rap rap
    ON rmd.rap_id = rap.rap_id
WHERE mrur.is_active = '1'
  AND mrur.user_id = 10701
  AND rap.rap_instance_id = (
        SELECT mo.meet_instc_id
        FROM meet_instc mo
        WHERE mo.rmm_id = mrur.rmm_id
          AND mo.dt_id = (
                SELECT MAX(mi.dt_id)
                FROM meet_instc mi
                JOIN meet_stat ms
                    ON mi.meet_stat_id = ms.meet_stat_id
                WHERE mi.rmm_id = mrur.rmm_id
                  AND mi.meet_stat_id IN (2, 1)
          )
  )
  AND rmd.metric_flag <> 'removed'
  AND ma.user_role_id <> mrur.rap_user_role_id;



UPDATE metric_access ma
SET ma.user_role_id = (
        SELECT mrur.rap_user_role_id
        FROM map_rap_user_role mrur
        JOIN rap_metrics_details rmd
            ON ma.metric_detail_id = rmd.metric_detail_id
        JOIN rap_rap rap
            ON rmd.rap_id = rap.rap_id
        WHERE mrur.user_id = ma.user_id
          AND mrur.is_active = '1'
          AND rap.rap_instance_id = (
                SELECT mo.meet_instc_id
                FROM meet_instc mo
                WHERE mo.rmm_id = mrur.rmm_id
                  AND mo.dt_id = (
                        SELECT MAX(mi.dt_id)
                        FROM meet_instc mi
                        JOIN meet_stat ms
                            ON mi.meet_stat_id = ms.meet_stat_id
                        WHERE mi.rmm_id = mrur.rmm_id
                          AND mi.meet_stat_id IN (2, 1)
                  )
          )
)
WHERE ma.user_id = 10701
  AND EXISTS (
        SELECT 1
        FROM map_rap_user_role mrur
        WHERE mrur.user_id = ma.user_id
          AND mrur.is_active = '1'
          AND ma.user_role_id <> mrur.rap_user_role_id
  );


SELECT COUNT(*) FROM metric_access
WHERE user_id = 10701;
