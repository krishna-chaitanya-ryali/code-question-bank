def process_system_driven_revoke(cursor, today):
    print("[SYSTEM-REVOKE] Running daily system revoke job")

    # 1️⃣ Identify non-responsive line managers
    lm_query = """
        SELECT DISTINCT LINE_MANAGER_ID
        FROM RECERTIFICATION_EMAIL_LIST
        WHERE MAIL_SENT_COUNT = 3
          AND LINE_MANAGER_ID IS NOT NULL
          AND (
              SELECT MIN(CREAT_DT)
              FROM RECERTIFICATION_EMAIL_LIST e2
              WHERE e2.LINE_MANAGER_ID = RECERTIFICATION_EMAIL_LIST.LINE_MANAGER_ID
                AND e2.MAIL_SENT_COUNT = 1
          ) + 31 <= TRUNC(SYSDATE)
    """

    cursor.execute(lm_query)
    lm_ids = [row[0] for row in cursor.fetchall()]

    for lm_id in lm_ids:
        process_users_under_lm(cursor, lm_id)



def process_users_under_lm(cursor, line_manager_id):

    user_query = """
        SELECT USER_ID, RMM_ID
        FROM USER_TAB
        WHERE LINE_MANAGER_ID = :lm_id
    """

    cursor.execute(user_query, {"lm_id": line_manager_id})
    users = cursor.fetchall()

    for user_id, rmm_id in users:

        # Check if record already exists
        check_query = """
            SELECT 1
            FROM RECREATE_RESPONSE
            WHERE REPORTEES_ID = :user_id
              AND RMM_ID = :rmm_id
        """
        cursor.execute(check_query, {"user_id": user_id, "rmm_id": rmm_id})

        if cursor.fetchone():
            continue  # Already handled

        print(f"[SYSTEM-REVOKE] Auto-revoking {user_id}/{rmm_id}")

        insert_system_revoke(cursor, user_id, rmm_id)
        revoke_user_access(cursor, user_id, rmm_id)


def insert_system_revoke(cursor, user_id, rmm_id):

    insert_query = """
        INSERT INTO RECREATE_RESPONSE (
            REPORTEES_ID,
            RMM_ID,
            ACCESS_STATUS,
            ACCESS_REVOKED_DATE_BY_LINE_MANAGER,
            CREATED_BY,
            CREATED_DT,
            IS_ACTIVE
        )
        VALUES (
            :user_id,
            :rmm_id,
            'REVOKE',
            NULL,
            'SYSTEM REVOKED',
            SYSDATE,
            0
        )
    """

    cursor.execute(insert_query, {
        "user_id": user_id,
        "rmm_id": rmm_id
    })
