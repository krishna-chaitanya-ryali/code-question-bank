UPDATE RECERTIFICATION_EMAIL_LIST
SET SYSTEM_REVOKE_DONE_IND = 'Y',
    SYSTEM_REVOKE_DONE_DT  = SYSTIMESTAMP
WHERE MAIL_SENT_YEAR = :year
  AND LINEMANAGER_ID = :lm_id;


SELECT CASE
         WHEN EXISTS (
           SELECT 1
           FROM RECERTIFICATION_EMAIL_LIST
           WHERE MAIL_SENT_YEAR = :year
             AND MAIL_SENT_COUNT = 3
             AND NVL(SYSTEM_REVOKE_DONE_IND,'N') = 'N'
         )
         THEN 'N'
         ELSE 'Y'
       END AS SYSTEM_RECERT_COMPLETED
FROM DUAL;