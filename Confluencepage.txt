USER_TAB (EMPLOYEE_ID)
   ↓
Batch LDAP lookup → get LM_ID + LM_NAME
   ↓
Collect unique LM_IDs
   ↓
Batch LDAP lookup → get LM_MAIL
   ↓
Merge data
   ↓
Bulk UPDATE USER_TAB
   ↓
Logs + metrics


LDAP_SERVER = "aa-lds-prod.hk.hsbc"
LDAP_PORT = 3269
LDAP_BASE_DN = "DC=InfoDir,DC=Prod,DC=HSBC"
LDAP_BIND_DN = "CN=Infodir-HBEL-gruapp,OU=Service Accounts,DC=InfoDir,DC=Prod,DC=HSBC"
LDAP_PASSWORD = "********"

BATCH_SIZE = 200
from log import log_debug, log_error


QueryString = {
    "FETCH_USERS": {
        "QString": """
            SELECT USER_ID, EMPLOYEE_ID
            FROM USER_TAB
            WHERE IS_ACTIVE = 1
        """
    },
    "UPDATE_USER_TAB_LM": {
        "QString": """
            UPDATE USER_TAB
            SET
                LINE_MANAGER_ID = :lm_id,
                LINE_MANAGER_NAME = :lm_name,
                LINE_MANAGER_MAIL_ID = :lm_mail,
                UPDATED_DT = SYSDATE
            WHERE USER_ID = :user_id
        """
    }
}


def populate_line_manager_details():
    """
    One-time job to populate Line Manager details in USER_TAB
    using EMPLOYEE_ID → Active Directory lookup.
    """

    log_debug.debug("[LM_POPULATE] Job started")

    # Metrics
    total_users = 0
    ad_users_found = 0
    lm_mail_found = 0
    rows_updated = 0
    missing_manager_mail = 0
    errors = 0

    try:
        users = fetch_users_from_db()
        total_users = len(users)

        log_debug.debug(f"[LM_POPULATE] Total users fetched: {total_users}")

        # Reuse ONE AD connection
        server = Server(LDAP_SERVER, port=LDAP_PORT, use_ssl=True)
        conn = Connection(
            server,
            LDAP_BIND_DN,
            LDAP_PASSWORD,
            auto_bind=True
        )

        for batch in chunk_list(users, BATCH_SIZE):
            emp_results = fetch_employee_lm_details(conn, batch)
            ad_users_found += len(emp_results)

            manager_ids = {
                rec["lm_id"] for rec in emp_results if rec["lm_id"]
            }

            manager_mail_map = fetch_manager_mails(conn, manager_ids)
            lm_mail_found += len(manager_mail_map)

            updates = []

            for rec in emp_results:
                lm_mail = manager_mail_map.get(rec["lm_id"])

                if not lm_mail:
                    missing_manager_mail += 1
                    lm_mail = None  # fallback (allowed)

                updates.append({
                    "user_id": rec["user_id"],
                    "lm_id": rec["lm_id"],
                    "lm_name": rec["lm_name"],
                    "lm_mail": lm_mail
                })

            if updates:
                updated = Db_Con.bulk_update_data(
                    QueryString["UPDATE_USER_TAB_LM"]["QString"],
                    updates
                )
                rows_updated += updated

        log_debug.debug(
            "[LM_POPULATE] Completed | "
            f"users={total_users}, "
            f"ad_found={ad_users_found}, "
            f"lm_mail_found={lm_mail_found}, "
            f"missing_lm_mail={missing_manager_mail}, "
            f"rows_updated={rows_updated}, "
            f"errors={errors}"
        )

    except Exception:
        log_error.error("[LM_POPULATE] Job failed", exc_info=True)


def fetch_users_from_db():
    rows = Db_Con.getData(QueryString["FETCH_USERS"]["QString"])
    return [
        {"user_id": r["USER_ID"], "employee_id": r["EMPLOYEE_ID"]}
        for r in rows
    ]



def fetch_employee_lm_details(conn, users):
    """
    Fetch Line Manager ID & Name for employees (batch).
    """

    psids = [u["employee_id"] for u in users]

    search_filter = "(|{})".format(
        "".join(f"(name={psid})" for psid in psids)
    )

    conn.search(
        LDAP_BASE_DN,
        f"(&(objectClass=UserProxy)(objectCategory=UserProxy){search_filter})",
        attributes=[
            "hsbc-ad-SAMAccountName",
            "hsbc-ad-LineManagerID",
            "hsbc-ad-LineManagerName"
        ]
    )

    results = []
    user_map = {u["employee_id"]: u["user_id"] for u in users}

    for entry in conn.entries:
        emp_id = str(entry["hsbc-ad-SAMAccountName"])
        lm_id = str(entry["hsbc-ad-LineManagerID"]) if "hsbc-ad-LineManagerID" in entry else None
        lm_name = str(entry["hsbc-ad-LineManagerName"]) if "hsbc-ad-LineManagerName" in entry else None

        results.append({
            "user_id": user_map.get(emp_id),
            "lm_id": lm_id,
            "lm_name": lm_name
        })

    return results


def fetch_manager_mails(conn, manager_ids):
    """
    Fetch Line Manager mail IDs in batches.
    Returns dict {manager_id: mail}
    """

    manager_mail_map = {}

    if not manager_ids:
        return manager_mail_map

    manager_ids = list(manager_ids)

    for batch in chunk_list(manager_ids, BATCH_SIZE):
        search_filter = "(|{})".format(
            "".join(f"(name={mid})" for mid in batch)
        )

        conn.search(
            LDAP_BASE_DN,
            f"(&(objectClass=UserProxy)(objectCategory=UserProxy){search_filter})",
            attributes=["name", "mail"]
        )

        for entry in conn.entries:
            mid = str(entry["name"])
            mail = str(entry["mail"]) if "mail" in entry else None
            manager_mail_map[mid] = mail

    return manager_mail_map


def chunk_list(data, size):
    for i in range(0, len(data), size):
        yield data[i:i + size]


def bulk_update_data(self, sqlQry, param_list):
    try:
        self.__cursor.executemany(sqlQry, param_list)
        rowcount = self.__cursor.rowcount
        self.__con.commit()
        return rowcount
    except Exception:
        log_error.error("Bulk update failed", exc_info=True)
        raise
