SELECT DISTINCT rel.LINEMANAGER_ID
FROM RECERTIFICATION_EMAIL_LIST rel
WHERE rel.MAIL_SENT_COUNT = 3
  AND rel.LINEMANAGER_ID IS NOT NULL
  AND rel.MAIL_SENT_YEAR = :recert_year
  AND NVL(rel.SYSTEM_REVOKE_DONE_IND, 'N') = 'N'
  AND (
        SELECT MIN(e2.CREAT_DT)
        FROM RECERTIFICATION_EMAIL_LIST e2
        WHERE e2.LINEMANAGER_ID = rel.LINEMANAGER_ID
          AND e2.MAIL_SENT_COUNT = 1
          AND e2.MAIL_SENT_YEAR = rel.MAIL_SENT_YEAR
      ) + 31 <= TRUNC(SYSDATE);



UPDATE RECERTIFICATION_EMAIL_LIST
SET SYSTEM_REVOKE_DONE_IND = 'Y',
    SYSTEM_REVOKE_DONE_DT  = SYSTIMESTAMP,
    UPDT_DT               = SYSTIMESTAMP,
    UPDT_USER_ID          = 'SYSTEM_REVOKE_JOB'
WHERE MAIL_SENT_YEAR = :recert_year
  AND NVL(SYSTEM_REVOKE_DONE_IND, 'N') = 'N';


UPDATE RECERTIFICATION_EMAIL_LIST
SET SYSTEM_REVOKE_DONE_IND = 'Y';
